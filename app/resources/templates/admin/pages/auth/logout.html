{% extends 'admin/base/auth_base.html' %}
{% block title %}Signing out... - {{ super() }}{% endblock %}

{% block content %}
<div class="form-wrapper h-full my-auto flex align-center justify-center">
    <div class="card w-full md:w-96 xl:w-4/12 p-6 rounded-lg shadow border bg-white border-gray-200 text-gray-900 min-h-[200px] flex flex-col items-center justify-center">
        <div class="w-12 h-12 border-4 border-[#c3622d]/30 border-t-[#c3622d] rounded-full animate-spin mb-4"></div>
        <p class="text-sm text-gray-700">Signing you out â€” you will be redirected shortly.</p>
    </div>
</div>
{% endblock %}

{% block scripts %}
    {{ super() }}
    <script>
        // Immediately clear all Clerk-related cookies and storage
        (function() {
            try {
                Object.keys(localStorage || {}).forEach(k => {
                    if (k.toLowerCase().includes("clerk")) localStorage.removeItem(k);
                });
                Object.keys(sessionStorage || {}).forEach(k => {
                    if (k.toLowerCase().includes("clerk")) sessionStorage.removeItem(k);
                });
            } catch (e) {}
            try {
                ["__session", "clerk_session", "__clerk", "__client"].forEach(name => {
                    document.cookie = `${name}=; Max-Age=0; path=/;`;
                    document.cookie = `${name}=; Max-Age=0; path=/; domain=${location.hostname};`;
                });
            } catch (e) {}
        })();
    </script>
    {% if clerk_publishable_key %}
    <script async crossorigin="anonymous" data-clerk-publishable-key="{{ clerk_publishable_key }}" src="https://cdn.jsdelivr.net/npm/@clerk/clerk-js@latest/dist/clerk.browser.js"></script>
    <script>
        window.addEventListener("load", async () => {
            const loginUrl = "{{ login_url }}";
            
            // Helper to clear all Clerk data
            function clearClerkData() {
                try {
                    Object.keys(localStorage || {}).forEach(k => {
                        if (k.toLowerCase().includes("clerk")) localStorage.removeItem(k);
                    });
                    Object.keys(sessionStorage || {}).forEach(k => {
                        if (k.toLowerCase().includes("clerk")) sessionStorage.removeItem(k);
                    });
                } catch (e) {}
                try {
                    ["__session", "clerk_session", "__clerk", "__client"].forEach(name => {
                        document.cookie = `${name}=; Max-Age=0; path=/;`;
                        document.cookie = `${name}=; Max-Age=0; path=/; domain=${location.hostname};`;
                    });
                } catch (e) {}
            }

            // Clear data first
            clearClerkData();

            try {
                // Wait for Clerk to load
                if (window.Clerk) {
                    await window.Clerk.load();
                    
                    // Sign out if there's an active session
                    if (window.Clerk.user || window.Clerk.session) {
                        await window.Clerk.signOut();
                    }
                    
                    // Clear data again after sign out
                    clearClerkData();
                }
            } catch (e) {
                console.warn("Clerk signOut error (ignored):", e);
            }

            // Redirect to login after a brief delay to ensure cleanup completes
            setTimeout(() => {
                window.location.href = loginUrl;
            }, 500);
        });
    </script>
    {% else %}
    <script>
        // No Clerk key - just redirect immediately
        window.location.href = "{{ login_url }}";
    </script>
    {% endif %}
{% endblock %}
